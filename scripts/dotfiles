#!/usr/bin/env bash

# dotfiles: fetch configuration files and scripts
# usage: dotfiles
# this file is disgusting, and will never be fixed.

installed() {
	local cmd=$(command -v "${1}")

	[[ -n "${cmd}" ]] && [[ -f "${cmd}" ]]
	return ${?}
}

green() {
	printf "${COLOR_GRN}${@}${COLOR_NRM}.\n"
}

yellow() {
	printf "${COLOR_YLW}${@}${COLOR_NRM}.\n"
}

die() {
	echo "Error: $*" >&2
	exit 1
}

ensure() {
	"$@" \
		|| die "Failed to run '$*'. Aborting."
}

fetch_files() {
	local system=$(uname)
	local host=$(hostname)

	if ! installed git ; then
		die "git required to fetch configs."
		exit 1
	fi

	pushd . > /dev/null

	# make sure the repo isn't clobbered
	if [[ -d ~/.dotfiles/.git ]] ; then
		cd ~/.dotfiles
		ensure git fetch origin --quiet > /dev/null
		ensure git merge origin/master > /dev/null
	else
		ensure rm -rf ~/.dotfiles
		ensure git clone https://github.com/woodruffw/dotfiles ~/.dotfiles > /dev/null
	fi

	popd > /dev/null

	mkdir -p ~/scripts

	printf "Reloading bashrc, inputrc, profile, and completions..."
	cp ~/.dotfiles/bashrc ~/.bashrc
	cp ~/.dotfiles/inputrc ~/.inputrc
	cp ~/.dotfiles/profile ~/.profile
	cp ~/.dotfiles/bash_completion ~/.bash_completion
	mkdir -p ~/.bash_completion.d
	cp -R ~/.dotfiles/bash_completion.d/* ~/.bash_completion.d
	green "done"

	# we know git is installed
	printf "Reloading git-aliases, gitignore, and gitconfig..."
	cp ~/.dotfiles/gitignore ~/.gitignore
	cp ~/.dotfiles/gitconfig ~/.gitconfig
	green "done"

	printf "Checking for vim..."
	if installed vim ; then
		printf "found. Reloading vimrc, scripts, and plugins... "
		cp ~/.dotfiles/vimrc ~/.vimrc
		mkdir -p ~/.vim/
		cp -R ~/.dotfiles/vim/* ~/.vim
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for curl..."
	if installed curl ; then
		printf "found. Reloading curlrc..."
		cp ~/.dotfiles/curlrc ~/.curlrc
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for rtorrent..."
	if installed rtorrent ; then
		printf "found. Reloading rtorrent.rc and magnet scripts..."
		if [[ ~/.dotfiles/rtorrent-${host}.rc ]]; then
			cp ~/.dotfiles/rtorrent-${host}.rc ~/.rtorrent.rc
		else
			printf "skipping rtorrent.rc.\n"
		fi

		cp ~/.dotfiles/scripts/magnet.sh ~/scripts/magnet.sh
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for tmux..."
	if installed tmux ; then
		printf "found. Reloading tmux.conf and session files..."
		if [[ $(tmux -V | awk '{ print $2 }' | tr -d '.') -le "18" ]]; then
			cp ~/.dotfiles/tmux.conf.1.8 ~/.tmux.conf
		else
			cp ~/.dotfiles/tmux.conf ~/.tmux.conf
		fi
		mkdir -p ~/.tmux
		cp ~/.dotfiles/tmux/* ~/.tmux/
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for xbindkeys..."
	if installed xbindkeys ; then
		printf "found. Reloading xbindkeysrc..."
		if [[ -f ~/.dotfiles/xbindkeysrc-${host} ]] ; then
			cp ~/.dotfiles/xbindkeysrc-${host} ~/.xbindkeysrc
			green "done"
		else
			printf "none required.\n"
		fi
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for thunar..."
	if installed thunar ; then
		printf "found. Reloading uca.xml..."
		mkdir -p ~/.config/Thunar
		cp ~/.dotfiles/config/Thunar/uca.xml ~/.config/Thunar/uca.xml
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for hexchat..."
	if installed hexchat ; then
		printf "found. Reloading configs and addons..."
		mkdir -p ~/.config/hexchat
		cp -R ~/.dotfiles/config/hexchat/* ~/.config/hexchat/
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for mpv..."
	if installed mpv ; then
		printf "found. Reloading configs..."
		mkdir -p ~/.mpv/{scripts,lua-settings}
		cp ~/.dotfiles/mpv/config ~/.mpv/config
		cp ~/.dotfiles/mpv/scripts/* ~/.mpv/scripts/
		cp ~/.dotfiles/mpv/lua-settings/osc.conf ~/.mpv/lua-settings/osc.conf
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for feh..."
	if installed feh ; then
		printf "found. Reloading themes, fehbg, and wallpaper..."
		mkdir -p ~/.config/feh
		cp ~/.dotfiles/config/feh/themes ~/.config/feh/themes
		cp ~/.dotfiles/fehbg ~/.fehbg
		cp ~/.dotfiles/config/feh/wallpaper ~/.config/feh/wallpaper
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for newsbeuter..."
	if installed newsbeuter ; then
		printf "found. Reloading config and scripts..."
		mkdir -p ~/.newsbeuter
		cp ~/.dotfiles/newsbeuter/config ~/.newsbeuter/config
		cp ~/.dotfiles/scripts/newsbeuter-yt-feed ~/scripts/newsbeuter-yt-feed
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for textadept..."
	if installed textadept ; then
		printf "found. Reloading configs, modules, and themes..."
		mkdir -p ~/.textadept
		cp -R ~/.dotfiles/textadept/* ~/.textadept
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for Sublime Text..."
	if installed subl ; then
		printf "found. Reloading preferences and themes..."
		cp -R ~/.dotfiles/config/sublime-text-3/* ~/.config/sublime-text-3
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for ruby..."
	if installed ruby ; then
		printf "found. Reloading bundle config, irbrc and gemrc..."
		mkdir -p ~/.bundle
		cp ~/.dotfiles/bundle/config ~/.bundle/config
		cp ~/.dotfiles/irbrc ~/.irbrc
		cp ~/.dotfiles/gemrc ~/.gemrc
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for urxvt..."
	if installed urxvt ; then
		printf "found. Reloading Xdefaults and extensions..."
		cp ~/.dotfiles/Xdefaults ~/.Xdefaults
		mkdir -p ~/.urxvt/ext
		cp -R ~/.dotfiles/urxvt/ext/* ~/.urxvt/ext
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for LaTeX..."
	if installed latex ; then
		printf "found. Reloading texmf and updating the database..."
		mkdir -p ~/texmf
		cp -R ~/.dotfiles/texmf/* ~/texmf
		installed texhash && texhash > /dev/null 2>&1
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for Firefox..."
	if installed firefox ; then
		printf "found. Reloading pipefox..."
		cp ~/.dotfiles/scripts/pipefox ~/scripts/pipefox
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for Google Chrome..."
	if installed google-chrome ; then
		printf "found. Reloading app scripts..."
		cp ~/.dotfiles/scripts/netflix ~/scripts/netflix
		cp ~/.dotfiles/scripts/subsonic ~/scripts/subsonic
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for i3..."
	if installed i3 ; then
		printf "found. Reloading config and scripts..."
		cp ~/.dotfiles/config/i3/config-${host} ~/.config/i3/config
		cp ~/.dotfiles/i3status-${host}.conf ~/.i3status.conf
		cp ~/.dotfiles/Xmodmap ~/.Xmodmap
		cp ~/.dotfiles/scripts/statusbar ~/scripts/statusbar
		cp ~/.dotfiles/scripts/monitors-${host} ~/scripts/monitors
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for muzak..."
	if installed muzakd ; then
		printf "found. Reloading utilities..."
		cp ~/.dotfiles/scripts/muzak-now-playing ~/scripts/muzak-now-playing
		cp ~/.dotfiles/scripts/muzak-rebase-index ~/scripts/muzak-rebase-index
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for kbsecret..."
	if installed kbsecret ; then
		printf "found. Reloading scripts..."
		cp ~/.dotfiles/scripts/kbsecret-zen-login ~/scripts/kbsecret-zen-login
		cp ~/.dotfiles/scripts/kbsecret-dmenu-pass ~/scripts/kbsecret-dmenu-pass
		cp ~/.dotfiles/scripts/kbsecret-snip ~/scripts/kbsecret-snip
		cp ~/.dotfiles/scripts/kbsecret-todo-list ~/scripts/kbsecret-todo-list
		cp ~/.dotfiles/scripts/todo ~/scripts/todo
		cp ~/.dotfiles/scripts/snip ~/scripts/snip
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Checking for uzbl..."
	if installed uzbl ; then
		printf "found. Reloading config..."
		cp ~/.dotfiles/config/uzbl/config ~/.config/uzbl/config
		green "done"
	else
		yellow "not installed. Skipping"
	fi

	printf "Fetching scripts..."
	cp ~/.dotfiles/scripts/dotfiles ~/scripts/dotfiles.new
	cp ~/.dotfiles/scripts/$ ~/scripts/$
	cp ~/.dotfiles/scripts/% ~/scripts/%
	cp ~/.dotfiles/scripts/colorscheme ~/scripts/colorscheme
	cp ~/.dotfiles/scripts/colorscheme2 ~/scripts/colorscheme2
	cp ~/.dotfiles/scripts/colormake ~/scripts/colormake
	cp ~/.dotfiles/scripts/cskel ~/scripts/cskel
	cp ~/.dotfiles/scripts/jskel ~/scripts/jskel
	cp ~/.dotfiles/scripts/linecheck ~/scripts/linecheck
	cp ~/.dotfiles/scripts/pbin ~/scripts/pbin
	cp ~/.dotfiles/scripts/update ~/scripts/update
	cp ~/.dotfiles/scripts/cart ~/scripts/cart
	cp ~/.dotfiles/scripts/speedtest ~/scripts/speedtest
	cp ~/.dotfiles/scripts/rip ~/scripts/rip
	cp ~/.dotfiles/scripts/sms ~/scripts/sms
	cp ~/.dotfiles/scripts/flac2mp3 ~/scripts/flac2mp3
	cp ~/.dotfiles/scripts/mp3art ~/scripts/mp3art
	cp ~/.dotfiles/scripts/flacart ~/scripts/flacart
	cp ~/.dotfiles/scripts/mdmath ~/scripts/mdmath
	cp ~/.dotfiles/scripts/worldtimes ~/scripts/worldtimes
	cp ~/.dotfiles/scripts/diff-highlight ~/scripts/diff-highlight
	cp ~/.dotfiles/scripts/uspatent ~/scripts/uspatent
	cp ~/.dotfiles/scripts/pid2xid ~/scripts/pid2xid
	cp ~/.dotfiles/scripts/albumart ~/scripts/albumart
	cp ~/.dotfiles/scripts/fwuf ~/scripts/fwuf
	cp ~/.dotfiles/scripts/aaa ~/scripts/aaa
	cp ~/.dotfiles/scripts/selecta ~/scripts/selecta
	cp ~/.dotfiles/scripts/ffmpeg-mosaic ~/scripts/ffmpeg-mosaic
	cp ~/.dotfiles/scripts/gif-length-groups ~/scripts/gif-length-groups
	cp ~/.dotfiles/scripts/giphy-fetch ~/scripts/giphy-fetch
	cp ~/.dotfiles/scripts/normalize-gifs ~/scripts/normalize-gifs
	cp ~/.dotfiles/scripts/last-photo ~/scripts/last-photo
	cp ~/.dotfiles/scripts/forecast ~/scripts/forecast
	cp ~/.dotfiles/scripts/rubyvm-dump ~/scripts/rubyvm-dump
	cp ~/.dotfiles/scripts/update-hosts ~/scripts/update-hosts

	if [[ "${system}" = "Darwin" ]]; then
		cp ~/.dotfiles/scripts/osx-vnc-password ~/scripts/osx-vnc-password
		cp -R ~/.dotfiles/gnupg/* ~/.gnupg
	fi

	if [[ "${host}" = "mercury" || "${host}" = "ianus" ]] ; then
		cp ~/.dotfiles/scripts/poomf ~/scripts/poomf
		cp ~/.dotfiles/scripts/play ~/scripts/play
		cp ~/.dotfiles/scripts/play-xclip ~/scripts/play-xclip
		cp ~/.dotfiles/scripts/uzbl-xclip ~/scripts/uzbl-xclip
		cp ~/.dotfiles/scripts/xdcc ~/scripts/xdcc
		cp ~/.dotfiles/scripts/twitch-${host} ~/scripts/twitch
		cp ~/.dotfiles/scripts/radio ~/scripts/radio
		cp ~/.dotfiles/scripts/xyzradio ~/scripts/xyzradio
		cp ~/.dotfiles/scripts/xontop ~/scripts/xontop
		cp ~/.dotfiles/scripts/tal ~/scripts/tal
		cp ~/.dotfiles/scripts/byzanz-rect ~/scripts/byzanz-rect
		cp ~/.dotfiles/scripts/screenfetch ~/scripts/screenfetch
		cp ~/.dotfiles/scripts/brewnav ~/scripts/brewnav
		cp ~/.dotfiles/scripts/subreddit-watch ~/scripts/subreddit-watch
		cp ~/.dotfiles/scripts/ezsshfs ~/scripts/ezsshfs
		cp ~/.dotfiles/scripts/nautilus-xenial-gopro-install ~/scripts/nautilus-xenial-gopro-install
		cp ~/.dotfiles/scripts/open-pdf ~/scripts/open-pdf
		cp ~/.dotfiles/scripts/bug-roommates ~/scripts/bug-roommates
		cp ~/.dotfiles/scripts/music ~/scripts/music

		mkdir -p ~/.local/share/file-manager/actions/
		cp ~/.dotfiles/local/share/file-manager/actions/*.desktop ~/.local/share/file-manager/actions/
	fi

	if [[ "${host}" = "athena" ]] ; then
		cp ~/.dotfiles/scripts/wwwbackup ~/scripts/wwwbackup
		cp ~/.dotfiles/scripts/dailymail.rb ~/scripts/dailymail.rb
		cp ~/.dotfiles/scripts/twitter-fortune-bot.pl ~/scripts/twitter-fortune-bot.pl
	fi

	chmod +x ~/scripts/*
	green "done"

	printf "Fetching cron-shunt and crontab..."
	cp ~/.dotfiles/scripts/cron-shunt ~/scripts/cron-shunt
	if [[ -f ~/.dotfiles/crontabs/${host}.cron ]] ; then
		mkdir -p ~/scripts/cron
		cp ~/.dotfiles/crontabs/${host}.cron ~/scripts/cron/${host}.cron
		crontab -r
		crontab ~/scripts/cron/${host}.cron
		green "done"
	else
		printf "none required.\n"
	fi

	printf "Doing some cleanup..."
	rm -f ~/scripts/haste
	rm -f ~/scripts/mpv-xclip
	rm -f ~/scripts/surf-xclip
	rm -f ~/scripts/email-fwd.rb
	rm -f ~/scripts/magnet-to-torrent.pl
	rm -f ~/scripts/speaker
	rm -f ~/scripts/tepm
	rm -f ~/.xsession-errors
	rm -f ~/.xsession-errors.old
	rm -f ~/.git-aliases
	rm -f ~/.tepmrc
	green "done"

	printf "Sync dotfiles-priv? (y/N): " && read ans
	if [[ -n $ans && "${ans}" =~ [Yy] ]] ; then
		ensure git clone git@gitlab.com:yossarian/dotfiles-priv.git ~/.dotfiles-priv 2> /dev/null
		pushd . > /dev/null
		cd ~/.dotfiles-priv
		ensure bash ./install.sh
		popd > /dev/null
		ensure rm -rf ~/.dotfiles-priv
	fi

	green "All done"
}

fetch_files

mv ~/scripts/dotfiles.new ~/scripts/dotfiles
